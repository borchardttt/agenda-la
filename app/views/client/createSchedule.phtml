<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamentos - Agenda-la</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body class="bg-[#F4E1C1] font-sans leading-normal tracking-normal">

<header class="bg-[#5C4033] text-[#F4E1C1] p-6">
    <div class="container mx-auto flex justify-between items-center">
        <div class="text-lg font-bold">
            <h1>Agenda-la</h1>
        </div>
        <nav class="space-x-4">
            <a href="/" class="hover:text-[#D3B18C]">Início</a>
            <a href="/services" class="hover:text-[#D3B18C]">Serviços</a>
            <a href="/client/mySchedules" class="hover:text-[#D3B18C]">Meus Agendamentos</a>
        </nav>
    </div>
</header>

<section class="flex justify-center items-center py-12">
    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-lg">
        <h2 class="text-2xl font-semibold text-center text-[#5C4033] mb-6">Agende seu horário</h2>
        <form id="appointmentForm" action="/client/createScheduling" method="POST">
            <div class="mb-4">
                <label for="barber_id" class="block text-[#5C4033] font-medium mb-2">Escolha o barbeiro</label>
                <select id="barber_id" name="barber_id" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#C78E31]" required>
                    <option value="">Selecione um barbeiro</option>
                    <?php foreach ($barbers as $barber) : ?>
                        <option value="<?= $barber->id ?>" data-availability='<?= json_encode($barbersDisponibility[$barber->id] ?? []) ?>'>
                            <?= $barber->name ?>
                        </option>
                    <?php endforeach; ?>
                </select>
            </div>
            <div class="mb-4">
                <label for="service_id" class="block text-[#5C4033] font-medium mb-2">Escolha o serviço</label>
                <select id="service_id" name="service_id" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#C78E31]" required>
                    <option value="">Selecione um serviço</option>
                    <?php foreach ($services as $service) : ?>
                        <option value="<?= $service->id ?>"><?= $service->name ?></option>
                    <?php endforeach; ?>
                </select>
            </div>
            <div class="mb-4">
                <label for="date" class="block text-[#5C4033] font-medium mb-2">Data e Hora</label>
                <input type="text" id="date" name="date" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#C78E31]" required>
            </div>
            <button type="submit" class="w-full bg-[#C78E31] text-[#5C4033] py-3 rounded-lg text-lg font-semibold hover:bg-[#D3B18C]">
                Confirmar Agendamento
            </button>
        </form>
    </div>
</section>

<footer class="bg-[#5C4033] text-[#F4E1C1] py-6 text-center">
    <p>&copy; 2024 Agenda-la. Todos os direitos reservados.</p>
</footer>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        let datetimePicker = flatpickr("#date", {
            enableTime: true,
            dateFormat: "Y-m-d H:i",
            minDate: "today",
            locale: "pt",
            disable: [],
            minTime: "08:00",
            maxTime: "18:00"
        });

        document.getElementById("barber_id").addEventListener("change", function () {
            const selectedOption = this.options[this.selectedIndex];
            const barberAvailability = JSON.parse(selectedOption.getAttribute('data-availability') || '{}');

            if (Object.keys(barberAvailability).length > 0) {
                updateAvailableDays(barberAvailability.week_days, datetimePicker);
                updateAvailableHours(barberAvailability.initial_hour, barberAvailability.final_hour, datetimePicker);
            }
        });
    });

    function updateAvailableDays(weekDays, datetimePicker) {
        if (!weekDays || weekDays.length === 0) {
            datetimePicker.set("disable", [{ from: "2000-01-01", to: "2100-01-01" }]);
            return;
        }

        const daysDisabled = [0, 1, 2, 3, 4, 5, 6].filter(day => !weekDays.includes(String(day)));

        datetimePicker.set("disable", [
            function(date) {
                return daysDisabled.includes(date.getDay());
            }
        ]);
    }

    function updateAvailableHours(initialHour, finalHour, datetimePicker) {
        if (!initialHour || !finalHour) return;

        datetimePicker.set("minTime", initialHour);
        datetimePicker.set("maxTime", finalHour);

        datetimePicker.config.onOpen = [
            function(selectedDates, dateStr, instance) {
                const selectedDate = selectedDates[0];
                if (!selectedDate) return;

                const minTime = new Date(selectedDate);
                const maxTime = new Date(selectedDate);
                const [initialHours, initialMinutes] = initialHour.split(':');
                const [finalHours, finalMinutes] = finalHour.split(':');

                minTime.setHours(initialHours, initialMinutes);
                maxTime.setHours(finalHours, finalMinutes);

                instance.set("minTime", minTime.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" }));
                instance.set("maxTime", maxTime.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" }));
            }
        ];
    }
</script>

</body>
</html>
